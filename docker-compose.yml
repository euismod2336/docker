version: "3"

services:
  apache:
    image: httpd:alpine
    volumes:
      - ./public_html:/usr/local/apache2/htdocs/
      - ./docker/httpd.conf:/usr/local/apache2/conf/httpd.conf
      - ./.env:/usr/local/apache2/.env
    environment:
      - FASTCGI=fcgi://phpfpm:9000
    hostname: "${HOSTNAME}"
    extra_hosts:
      - "${HOSTNAME}:127.0.0.1"
    networks:
      static-network:
        ipv4_address: "${IPADDRESS}.5"

  phpfpm:
    build:
      context: .
      dockerfile: "./docker/php${PHP}"
    extra_hosts:
      - "${HOSTNAME}:${IPADDRESS}.5"
    volumes:
      - ./docker/php.ini:/usr/local/etc/php/conf.d/50-setting.ini
      - ./public_html:/usr/local/apache2/htdocs/
      - ./vendor:/usr/local/apache2/vendor/
      - ./config:/usr/local/apache2/config/
      - ./storage:/usr/local/apache2/storage/
      - ./modules:/usr/local/apache2/modules/
      - ./templates:/usr/local/apache2/templates/
      - ./.env:/usr/local/apache2/.env
      - ./composer.json:/usr/local/apache2/composer.json
      - ./composer.lock:/usr/local/apache2/composer.lock
      - /data/projects/php/craft:/usr/local/craft
    networks:
      static-network:
        ipv4_address: "${IPADDRESS}.6"

  db:
    image: mysql:5.7
    volumes:
      - ./docker/db:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD=123
      - MYSQL_DATABASE=dbname
      - MYSQL_USER=dbuser
      - MYSQL_PASSWORD=123
    networks:
      static-network:
        ipv4_address: "${IPADDRESS}.7"

  elasticsearch1:
    build:
      context: .
      dockerfile: ./docker/es
    environment:
      - cluster.name=docker-cluster
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - "http.max_initial_line_length:8kb"
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - ./docker/elasticsearch1:/usr/share/elasticsearch/data
    networks:
      static-network:
        ipv4_address: "${IPADDRESS}.8"

  elasticsearch2:
    build:
      context: .
      dockerfile: ./docker/es
    environment:
      - cluster.name=docker-cluster
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - "discovery.zen.ping.unicast.hosts=elasticsearch1"
      - "http.max_initial_line_length:8kb"
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - ./docker/elasticsearch2:/usr/share/elasticsearch/data
    networks:
      static-network:
        ipv4_address: "${IPADDRESS}.9"

#   kibana:
#     image: docker.elastic.co/kibana/kibana-oss:6.3.0
#     environment:
#       SERVER_NAME: "kibana.${HOSTNAME}"
#       ELASTICSEARCH_URL: http://${IPADDRESS}.8:9200
#       ELASTICSEARCH_USERNAME: "elastic"
#       ELASTICSEARCH_PASSWORD: "changeme"
#     networks:
#       static-network:
#         ipv4_address: "${IPADDRESS}.10"

networks:
  static-network:
    ipam:
      config:
        - subnet: "${IPADDRESS}.0/28"